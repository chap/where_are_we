<script type="text/javascript">
  $(document).ready(function() {
    navigator.geolocation.getCurrentPosition(geo_success, geo_fail,{maximumAge:600000});
  });

  function geo_success(position) {
    $('#position_status').html("<img src='/images/success.png' />");
    $('#geo_status').html("<img src='/images/spinner.gif' />");
    jQuery.ajax({
      type: 'POST',
      url: '/visits',
      data: {
        visit: {
          ip: '<%= request.remote_ip %>',
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          positioning_success: true
        }
      },
      dataType: 'json',
      success: function(data, textStatus, request) {
        showCurrentAddress(data);
        $('#geo_status').html("<img src='/images/success.png' />");
        $('#match_status').html("<img src='/images/spinner.gif' />");
        match_country(data['visit']['id']);
      }
    });
  }
  
  function match_country(visit_id) {
    jQuery.ajax({
      type: 'POST',
      url: '/visits/' + visit_id + '/match_country',
      dataType: 'json',
      success: function(data, textStatus, request) {
        showMatch(data);
        $('#match_status').html("<img src='/images/success.png' />");
        $('#debug').hide();
      }
    });
  }

  function showCurrentAddress(data) {
    $('#look_around').show();
    $('#city_state').html(data['visit']['city_state']);
    
    $('#my_rate').html(data['visit']['unemployment_rate'] + '%');
    $('#lot_like').show();
  }
  
  function showMatch(data) {
    $('#match').html(data['country']['name']);
    $('#match_rate').html(data['country']['unemployment_rate'] + '%');
    $('#concerned').show();
    $('#rates').show();
  }

  function geo_fail(position) {
    $('#position_status').html("<img src='/images/fail.png' />");
  	jQuery.ajax({
      type: 'POST',
      url: '/visits.json',
      data: {
        visit: {
          ip: '<%= request.remote_ip %>',
          positioning_success: false
        }
      }
    });
  }
</script>

<div id="debug" style="magin-bottom:20px;">
  <h3><span id="position_status"><img src='/images/spinner.gif' /></span> Grant permission</h3>
  <h3><span id="geo_status">2</span> Map location</h3>
  <h3><span id="match_status">3</span> Match</h3>
</div>

<h3 id="look_around" style="display:none;">look around,</h3>
<h1 id="city_state"></h1>
<h3 id="lot_like" style="display:none;">is a lot like</h3>
<h1 id="match"></h1>

<h3 id="concerned" style="display:none;">in terms of unemployment</h3>
<h1 id="rates" style="display:none;">
 <span id="my_rate"></span> v 
 <span id="match_rate"></span>
</h1>